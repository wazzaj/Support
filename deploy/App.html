<!DOCTYPE html>
<html>
<head>
    <title>TimeSheetReport</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",items:[{xtype:"container",itemId:"fieldContainer"},{xtype:"container",itemId:"buttonContainer",cls:"container buttonContainer"},{xtype:"container",itemId:"gridContainer",cls:"container"},{xtype:"container",itemId:"tableContainer",cls:"container"},{xtype:"component",id:"exportFrame",autoEl:{tag:"iframe",style:"display:none"}}],launch:function(){Ext.getBody().mask("Loading..."),this.INDENT=8,this.MAX_OR_CLAUSES=95,this.EXCEL_FILE_NAME="timesheet.xls",this.COMBOBOX_TEMPLATE='<tpl for="."><div class="x-boundlist-item">{[values["FormattedID"] + " : " + values["_refObjectName"]]}</div></tpl>',this.COMBOBOX_DISPLAY_TEMPLATE='<tpl for=".">{[values["FormattedID"] + " : " + values["_refObjectName"]]}</tpl>',this.EXCEL_URI="data:application/vnd.ms-excel;base64,",this.EXCEL_TEMPLATE='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>worksheet</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><meta charset="utf-8"></head><body style="font-size:11pt">',this.EXPORT_ACTION={title:"EXPORT",func:this._exportReport},this.PRINT_ACTION={title:"PRINT",func:this._printReport},this.SUMMARY_WITHOUT_CHILDREN="withoutChildren",this.SUMMARY_WITH_CHILDREN="withChildren",this.USER_STORY_LIST_TYPE="userStoryList",this.TIME_DETAIL_TYPE="timeDetails",this.GROUP_BY_WORKPACKAGE="workpackage",this.GROUP_BY_TEAM="team",this.currentReportType=null,this.currentGroupByType=null,this.treeMap=new Ext.util.HashMap,this.estimateMap=new Ext.util.HashMap,this.toDoMap=new Ext.util.HashMap,this.timeSpentMap=new Ext.util.HashMap,this.artifactTimeSpentMap=new Ext.util.HashMap,this.userStories=[],this.schedulableArtifacts=[],this.tasks=[],this.workpackageMap=new Ext.util.HashMap,this.timeEntries=[],this.filteredTimeEntries=[],this._addProposalComboBox()},_addProposalComboBox:function(){this.proposalComboBox=Ext.create("Rally.ui.combobox.ComboBox",{storeConfig:{model:" PortfolioItem/Proposal",autoLoad:!0,limit:1/0,fetch:["FormattedID"]},fieldLabel:"Proposal list:",labelAlign:"right",labelWidth:150,width:600,padding:"20 10 5 10",tpl:this.COMBOBOX_TEMPLATE,displayTpl:this.COMBOBOX_DISPLAY_TEMPLATE,editable:!1,listeners:{ready:this._addWorkPackageComboBox,select:this._loadWorkPackages,scope:this}}),this.down("#fieldContainer").add(this.proposalComboBox)},_addWorkPackageComboBox:function(){var proposalCount=this.proposalComboBox.getStore().getCount(),selectedProposal;selectedProposal=0===proposalCount?null:this.proposalComboBox.getRecord().get("_ref"),this.workpackageStore=Ext.create("Rally.data.wsapi.Store",{model:"Portfolioitem/WorkPackage",filters:[{property:"parent",operation:"=",value:selectedProposal}],fetch:["FormattedID","Name"],autoLoad:!0}),this.workpackageComboBox=Ext.create("Rally.ui.combobox.ComboBox",{store:this.workpackageStore,fieldLabel:"Work package list:",labelAlign:"right",labelWidth:150,width:600,padding:"5 10 5 10",allowNoEntry:!0,editable:!1,tpl:this.COMBOBOX_TEMPLATE,displayTpl:this.COMBOBOX_DISPLAY_TEMPLATE,listeners:{ready:this._addUserStoryComboBox,select:function(){this._getFilteredTimeEntries(),this._loadEpicUserStories(!1)},scope:this}}),this.down("#fieldContainer").add(this.workpackageComboBox)},_loadWorkPackages:function(){var me=this;Ext.getBody().mask("Loading...");var selectedProposal=this.proposalComboBox.getRecord().get("_ref"),filter={property:"parent",operation:"=",value:selectedProposal};this.workpackageStore.setFilter(filter),this.workpackageStore.load(function(){me.workpackageComboBox.setValue(this.getAt(0)),me._loadEpicUserStories(!0)})},_addUserStoryComboBox:function(){var me=this,workpackageCount=this.workpackageComboBox.getStore().getCount();0!==workpackageCount&&(me.epicUserStoryStore=Ext.create("Rally.data.wsapi.Store",{model:"UserStory",limit:1/0,filters:me._getEpicUserStoryFilter(),autoLoad:!0}),me.userStoryComboBox=Ext.create("Rally.ui.combobox.ComboBox",{store:me.epicUserStoryStore,fieldLabel:"User story list:",labelAlign:"right",labelWidth:150,width:600,padding:"5 10 10 10",allowNoEntry:!0,editable:!1,tpl:me.COMBOBOX_TEMPLATE,displayTpl:me.COMBOBOX_DISPLAY_TEMPLATE,listeners:{ready:me._addStartDatePicker,select:function(){me._getFilteredTimeEntries(),me._showReport()},scope:this}}),this.down("#fieldContainer").add(this.userStoryComboBox))},_loadEpicUserStories:function(loadUserStoryAndTask){var me=this;Ext.getBody().mask("Loading...");var selectedWorkPackge=me.workpackageComboBox.getRecord().get("_ref"),filter=this._getEpicUserStoryFilter();this.epicUserStoryStore.setFilter(filter),this.epicUserStoryStore.load(function(){me.userStoryComboBox.setValue(this.getAt(0)),loadUserStoryAndTask?me._loadUserStories():(me._getFilteredTimeEntries(),me._showReport())})},_addStartDatePicker:function(){var today=new Date,oneYearBefore=new Date;oneYearBefore.setFullYear(oneYearBefore.getFullYear()-1);var twoWeeksBefore=new Date;twoWeeksBefore.setDate(twoWeeksBefore.getDate()-14),this.startDatePicker=Ext.create("Rally.ui.DateField",{fieldLabel:"Start date:",labelAlign:"right",labelWidth:150,padding:"5 10 10 10",value:twoWeeksBefore,minValue:oneYearBefore,maxValue:today,editable:!1,listeners:{afterRender:this._addEndDatePicker,select:this._loadTimeSheetData,scope:this}}),this.down("#fieldContainer").add(this.startDatePicker)},_addEndDatePicker:function(){var today=new Date,oneYearBefore=new Date;oneYearBefore.setFullYear(today.getFullYear()-1),this.endDatePicker=Ext.create("Rally.ui.DateField",{fieldLabel:"End date:",labelAlign:"right",padding:"5 10 10 10",labelWidth:150,value:today,minValue:oneYearBefore,maxValue:today,editable:!1,listeners:{afterRender:this._addReportRadioButtons,select:this._loadTimeSheetData,scope:this}}),this.down("#fieldContainer").add(this.endDatePicker)},_addReportRadioButtons:function(){var me=this;me.currentReportType=me.USER_STORY_LIST_TYPE,me.reportRadioButtonPanel=Ext.create("Ext.container.Container",{height:30,width:400,layout:{align:"stretch",type:"vbox"},defaults:{labelWidth:150},items:[{xtype:"radiogroup",fieldLabel:"Report type:",labelAlign:"right",itemId:"reportType",columns:2,items:[{xtype:"radiofield",boxLabel:"User story list",name:"type",checked:!0,inputValue:me.USER_STORY_LIST_TYPE},{xtype:"radiofield",boxLabel:"Timesheet report",name:"type",inputValue:me.TIME_DETAIL_TYPE}],listeners:{change:me._showReport,scope:me}}],listeners:{afterRender:me._addExportButton,scope:me}}),me.down("#fieldContainer").add(me.reportRadioButtonPanel)},_addGroupRadioButtons:function(){var me=this;me.currentGroupByType=me.GROUP_BY_WORKPACKAGE,me.groupRadioButtonPanel=Ext.create("Ext.container.Container",{height:30,width:400,itemId:"groupRadioButton",layout:{align:"stretch",type:"vbox"},defaults:{labelWidth:150},items:[{xtype:"radiogroup",fieldLabel:"Group by",labelAlign:"right",itemId:"groupType",columns:2,items:[{xtype:"radiofield",boxLabel:"Work package",name:"group",checked:!0,inputValue:me.GROUP_BY_WORKPACKAGE},{xtype:"radiofield",boxLabel:"Team",name:"group",inputValue:me.GROUP_BY_TEAM}],listeners:{change:me._refreshDetailedTable,scope:me}}],listeners:{afterRender:me._refreshDetailedTable,scope:me}}),me.down("#fieldContainer").add(me.groupRadioButtonPanel)},_addExportButton:function(){var me=this;me.exportButton=Ext.create("Ext.Button",{text:"Export to Excel...",listeners:{afterRender:this._addPrintButton,scope:this},handler:function(){me.currentReportType==me.USER_STORY_LIST_TYPE?me._showDialog(me.EXPORT_ACTION):me._exportReport(!1)}}),this.down("#buttonContainer").add(this.exportButton)},_addPrintButton:function(){var me=this;me.printButton=Ext.create("Ext.Button",{text:"Print...",margin:"0 0 0 15",listeners:{afterRender:this._loadUserStories,scope:this},handler:function(){me.currentReportType==me.USER_STORY_LIST_TYPE?me._showDialog(me.PRINT_ACTION):me._printReport(!1)}}),this.down("#buttonContainer").add(this.printButton)},_loadUserStories:function(){var me=this,selectedWorkPackge=this.workpackageComboBox.getRecord().get("_ref");me.userStoryStore=Ext.create("Rally.data.wsapi.Store",{model:"UserStory",fetch:["tasks","defects","ObjectID","Parent","DirectChildrenCount","TaskEstimateTotal","TaskRemainingTotal","FormattedID","Children","WorkPackage","Name","Project","Owner","ScheduleState","PlanEstimate","DisplayName"],filters:me._getUserStoryFilter(),autoLoad:!0,limit:1/0,listeners:{load:function(userStoryStore,data){me.tasks=[],me.userStories=[],me.schedulableArtifacts=[],me.treeMap.clear(),me.estimateMap.clear(),me.toDoMap.clear(),me.workpackageMap.clear(),data&&data.length>0?(data.forEach(function(userStory){var userStoryID=userStory.get("ObjectID");me.estimateMap.add(userStoryID,userStory.get("TaskEstimateTotal")),me.toDoMap.add(userStoryID,userStory.get("TaskRemainingTotal")),userStory.get("Parent")&&me.treeMap.add(userStoryID,userStory.get("Parent").ObjectID),me.userStories.push(userStory),me.schedulableArtifacts.push(userStory),me.workpackageMap.add(userStoryID,userStory.get("WorkPackage"))}),me.currentArtifactIndex=0,me._loadDefects()):me._loadTimeSheetData()}}})},_loadDefects:function(){var me=this;if(0===me.userStories.length)return me._loadTasks(),void 0;for(var defectCount,userStory,userStoryID,filter,allFilter,i=0;me.MAX_OR_CLAUSES>i&&(userStory=me.userStories.shift(),defectCount=userStory.get("Defects").Count,defectCount>0&&(userStoryID=userStory.get("ObjectID"),filter=Ext.create("Rally.data.QueryFilter",{property:"Requirement.ObjectID",operator:"=",value:userStoryID}),allFilter=allFilter?allFilter.or(filter):filter),0!==me.userStories.length);i++);allFilter?Ext.create("Rally.data.wsapi.Store",{model:"Defect",fetch:["tasks","ObjectID","Requirement","DirectChildrenCount","TaskEstimateTotal","TaskRemainingTotal","FormattedID","Name"],filters:allFilter,autoLoad:!0,limit:1/0,listeners:{load:function(store,data){var defectId;data&&data.length>0&&_.each(data,function(value){defectId=value.get("ObjectID"),me.estimateMap.add(defectId,value.get("TaskEstimateTotal")),me.toDoMap.add(defectId,value.get("TaskRemainingTotal")),value.get("Requirement")&&me.treeMap.add(defectId,value.get("Requirement").ObjectID),me.schedulableArtifacts.push(value),me.workpackageMap.add(defectId,me.workpackageMap.get(value.get("Requirement").ObjectID))}),me._loadDefects()}}}):me._loadDefects()},_loadTasks:function(){var me=this;if(me.currentArtifactIndex==me.schedulableArtifacts.length)return me._loadTimeSheetData(),void 0;for(var taskCount,userStoryID,schedulableArtifact,filter,allFilter,i=0;me.MAX_OR_CLAUSES>i;i++){schedulableArtifact=me.schedulableArtifacts[me.currentArtifactIndex],taskCount=schedulableArtifact.get("Tasks").Count;var schedulableArtifactID=schedulableArtifact.get("ObjectID");if(taskCount>0&&(filter=Ext.create("Rally.data.QueryFilter",{property:"WorkProduct.ObjectID",operator:"=",value:schedulableArtifactID}),allFilter=allFilter?allFilter.or(filter):filter),me.currentArtifactIndex++,me.currentArtifactIndex===me.schedulableArtifacts.length)break}allFilter?Ext.create("Rally.data.wsapi.Store",{model:"Task",filters:allFilter,autoLoad:!0,limit:1/0,listeners:{load:function(store,data){var taskId;data&&data.length>0&&_.each(data,function(value){taskId=value.get("ObjectID"),me.treeMap.add(taskId,value.get("WorkProduct").ObjectID),me.tasks.push(value)}),me._loadTasks()}}}):me._loadTasks()},_loadTimeSheetData:function(){Ext.getBody().mask("Loading...");var me=this;me.timeSpentMap.clear(),me.artifactTimeSpentMap.clear(),me.timeEntries=[],me.currentArtifactIndex=0,me._loadTimeEntriesByArtifact()},_loadTimeEntriesByArtifact:function(){var me=this;if(me.currentArtifactIndex==me.schedulableArtifacts.length)return 0===me.tasks.length?me._showReport():(me.currentTaskIndex=0,me._loadTimeEntriesByTask()),void 0;var artifact,artifactId,artifactIdFilter,allFilter;allFilter=Ext.create("Rally.data.QueryFilter",{property:"DateVal",operator:">=",value:me._toISOString(me.startDatePicker.getValue())}).and(Ext.create("Rally.data.QueryFilter",{property:"DateVal",operator:"<=",value:me._toISOString(me.endDatePicker.getValue())})).and(Ext.create("Rally.data.QueryFilter",{property:"TimeEntryItem.Task",operator:"=",value:null})).and(Ext.create("Rally.data.QueryFilter",{property:"TimeEntryItem.WorkProduct",operator:"!=",value:null})).and(Ext.create("Rally.data.QueryFilter",{property:"Hours",operator:">",value:0}));for(var i=0;me.MAX_OR_CLAUSES>i&&(artifact=me.schedulableArtifacts[me.currentArtifactIndex],artifactId=artifact.get("ObjectID"),artifactIdFilter=artifactIdFilter?artifactIdFilter.or(Ext.create("Rally.data.QueryFilter",{property:"TimeEntryItem.WorkProduct.ObjectID",operator:"=",value:artifactId})):Ext.create("Rally.data.QueryFilter",{property:"TimeEntryItem.WorkProduct.ObjectID",operator:"=",value:artifactId}),me.currentArtifactIndex++,me.currentArtifactIndex!=me.schedulableArtifacts.length);i++);allFilter=allFilter.and(artifactIdFilter),Ext.create("Rally.data.wsapi.Store",{model:"TimeEntryValue",filters:allFilter,fetch:["ObjectID","Hours","DateVal","TimeEntryItem","Project","FormattedID","WorkProduct","User","Name","DisplayName"],limit:1/0,autoLoad:!0,listeners:{load:function(store,data){if(data&&data.length>0){var timeEntryItem,workpackage,detail;_.each(data,function(value){timeEntryItem=value.get("TimeEntryItem"),workpackage=me.workpackageMap.get(timeEntryItem.WorkProduct.ObjectID),detail={workpackageID:workpackage.ObjectID,workpackageName:workpackage.FormattedID+" : "+workpackage.Name,teamID:timeEntryItem.Project.ObjectID,teamName:timeEntryItem.Project.Name,userStoryID:me._getRootParentID(timeEntryItem.WorkProduct.ObjectID),who:timeEntryItem.User.DisplayName,workItem:timeEntryItem.WorkProduct.FormattedID+" : "+timeEntryItem.WorkProduct.Name,date:value.get("DateVal"),hours:value.get("Hours")},me.timeEntries.push(detail),me._setTimeSpentByObjectId(timeEntryItem.WorkProduct.ObjectID,value.get("Hours")),me._setArtifactTimeSpentByObjectId(timeEntryItem.WorkProduct.ObjectID,value.get("Hours"))})}me._loadTimeEntriesByArtifact()}}})},_loadTimeEntriesByTask:function(){var me=this;if(me.currentTaskIndex==me.tasks.length)return me.filteredTimeEntries=me.timeEntries,me._showReport(),void 0;var taskId,task,taskIdFilter,allFilter;allFilter=Ext.create("Rally.data.QueryFilter",{property:"DateVal",operator:">=",value:me._toISOString(me.startDatePicker.getValue())}).and(Ext.create("Rally.data.QueryFilter",{property:"DateVal",operator:"<=",value:me._toISOString(me.endDatePicker.getValue())})).and(Ext.create("Rally.data.QueryFilter",{property:"TimeEntryItem.Task",operator:"!=",value:null})).and(Ext.create("Rally.data.QueryFilter",{property:"Hours",operator:">",value:0}));for(var i=0;me.MAX_OR_CLAUSES>i&&(task=me.tasks[me.currentTaskIndex],taskId=task.get("ObjectID"),me.estimateMap.add(taskId,task.get("Estimate")),me.toDoMap.add(taskId,task.get("ToDo")),taskIdFilter=taskIdFilter?taskIdFilter.or(Ext.create("Rally.data.QueryFilter",{property:"TimeEntryItem.Task.ObjectID",operator:"=",value:taskId})):Ext.create("Rally.data.QueryFilter",{property:"TimeEntryItem.Task.ObjectID",operator:"=",value:taskId}),me.currentTaskIndex++,me.currentTaskIndex!=me.tasks.length);i++);allFilter=allFilter.and(taskIdFilter),Ext.create("Rally.data.wsapi.Store",{model:"TimeEntryValue",filters:allFilter,fetch:["ObjectID","Hours","DateVal","TimeEntryItem","Project","Task","FormattedID","WorkProduct","User","Name","DisplayName"],limit:1/0,autoLoad:!0,listeners:{load:function(store,data){if(data&&data.length>0){var timeEntryItem,workpackage,detail;_.each(data,function(value){timeEntryItem=value.get("TimeEntryItem"),workpackage=me.workpackageMap.get(timeEntryItem.Task.WorkProduct.ObjectID),detail={workpackageID:workpackage.ObjectID,workpackageName:workpackage.FormattedID+" : "+workpackage.Name,teamID:timeEntryItem.Project.ObjectID,teamName:timeEntryItem.Project.Name,userStoryID:me._getRootParentID(timeEntryItem.Task.ObjectID),who:timeEntryItem.User.DisplayName,workItem:timeEntryItem.Task.FormattedID+" : "+timeEntryItem.Task.Name,date:value.get("DateVal"),hours:value.get("Hours")},me.timeEntries.push(detail),me._setTimeSpentByObjectId(timeEntryItem.Task.ObjectID,value.get("Hours"))})}me._loadTimeEntriesByTask()}}})},_setTimeSpentByObjectId:function(objectId,hours){this.timeSpentMap.get(objectId)?this.timeSpentMap.add(objectId,this._roundFloatNumber(this.timeSpentMap.get(objectId)+hours)):this.timeSpentMap.add(objectId,hours);var parentId=this.treeMap.get(objectId);parentId&&this._setTimeSpentByObjectId(parentId,hours)},_setArtifactTimeSpentByObjectId:function(objectId,hours){this.artifactTimeSpentMap.get(objectId)?this.artifactTimeSpentMap.add(objectId,this._roundFloatNumber(this.artifactTimeSpentMap.get(objectId)+hours)):this.artifactTimeSpentMap.add(objectId,hours)},_getFilteredTimeEntries:function(){var me=this,selectedWorkpackageID=me.workpackageComboBox.getRecord().get("ObjectID"),selectedUserStoryID=me.userStoryComboBox.getRecord().get("ObjectID");selectedWorkpackageID||selectedUserStoryID?(me.filteredTimeEntries=[],_.each(me.timeEntries,function(timeEntry){selectedWorkpackageID&&selectedWorkpackageID!=timeEntry.workpackageID||selectedUserStoryID&&selectedUserStoryID!=timeEntry.userStoryID||me.filteredTimeEntries.push(timeEntry)})):me.filteredTimeEntries=me.timeEntries},_showReport:function(obj,newValue){Ext.getBody().mask("Loading...");var me=this;newValue&&(me.currentReportType=newValue.type),Ext.ComponentQuery.query("#gridContainer")[0].remove(Ext.ComponentQuery.query("#timesheet")[0],!0),Ext.ComponentQuery.query("#tableContainer")[0].remove(Ext.ComponentQuery.query("#detailedTable")[0],!0),me.currentReportType==me.USER_STORY_LIST_TYPE?(me.currentGroupByType&&me.groupRadioButtonPanel.setVisible(!1),me._buildTreeStore()):me.currentReportType==me.TIME_DETAIL_TYPE&&(me.currentGroupByType?(me.groupRadioButtonPanel.setVisible(!0),me._addDetailedTable()):me._addGroupRadioButtons())},_buildTreeStore:function(){var me=this;Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:["userstory"],filters:me._getTreeUserStoryFilter(),sorters:[{property:"FormattedID",direction:"ASC"}],autoLoad:!0,enableHierarchy:!0,pageSize:20}).then({success:me._addTimesheet,scope:me})},_addTimesheet:function(store){var me=this;me.timesheet=Ext.create("Rally.ui.grid.TreeGrid",{itemId:"timesheet",store:store,enableEditing:!1,pagingToolbarCfg:{pageSizes:[20,50,100]},enableScheduleStateClickable:!1,enableColumnMove:!1,enableBulkEdit:!1,enableBlockedReasonPopover:!1,enableColumnHide:!1,columnCfgs:["FormattedId","Name","Project","Owner",{text:"State",dataIndex:"ScheduleState"},{text:"US/DE Plan Estimate",dataIndex:"PlanEstimate",renderer:function(v,m,r){return me._processNumberValue(v,!0)}},{text:"Task Estimate",dataIndex:"TaskEstimateTotal",renderer:function(v,m,r){return me._processNumberValue(me.estimateMap.get(r.get("ObjectID")),!0)}},{text:"Task To Do",dataIndex:"TaskRemainingTotal",renderer:function(v,m,r){return me._processNumberValue(me.toDoMap.get(r.get("ObjectID")),!0)}},{text:"Time Spent",dataIndex:"TaskRemainingTotal",renderer:function(v,m,r){return"task"==r.get("_type")?me._processNumberValue(me.timeSpentMap.get(r.get("ObjectID")),!0):me._processNumberValue(me.artifactTimeSpentMap.get(r.get("ObjectID")),!0)}},{text:"Time Spent Total",dataIndex:"TaskRemainingTotal",renderer:function(v,m,r){return"hierarchicalrequirement"!=r.get("_type")||r.get("Parent")?"":me._processNumberValue(me.timeSpentMap.get(r.get("ObjectID")),!0)}},{text:"Outstanding(Plan Est less Spent)",dataIndex:"PlanEstimate",renderer:function(v,m,r){return"hierarchicalrequirement"==r.get("_type")&&!r.get("Parent")&&v&&me.timeSpentMap.get(r.get("ObjectID"))?me._roundFloatNumber(v-me.timeSpentMap.get(r.get("ObjectID"))):""}}],listeners:{scope:me}}),me.down("#gridContainer").add(me.timesheet),me._generateSummaryRowMap(),Ext.getBody().unmask()},_refreshDetailedTable:function(obj,newValue){Ext.getBody().mask("Loading..."),Ext.ComponentQuery.query("#tableContainer")[0].remove(Ext.ComponentQuery.query("#detailedTable")[0],!0),newValue.group&&(this.currentGroupByType=newValue.group);var me=this;Ext.Function.defer(function(){me._addDetailedTable()},10)},_addDetailedTable:function(){var me=this;me.table=Ext.create("Ext.panel.Panel",{id:"detailedDiv",itemId:"detailedTable",layout:{type:"table",tableAttrs:{cellspacing:0,cellpadding:0},columns:6},defaults:{height:20},items:me._getTableItems()}),me.down("#tableContainer").add(me.table),Ext.getBody().unmask()},_getTableItems:function(){var me=this;return me.currentGroupByType==me.GROUP_BY_WORKPACKAGE?(me._sortTimeEntriesByWorkPackage(),me._getTableByWorkPackage()):me.currentGroupByType==me.GROUP_BY_TEAM?(me._sortTimeEntriesByTeam(),me._getTableByTeam()):[]},_getTableByWorkPackage:function(){var me=this,rows=[{html:"Work Package",cellCls:"headerCol"},{html:"Team",cellCls:"headerCol"},{html:"Who",cellCls:"headerCol"},{html:"Work Item",cellCls:"headerCol"},{html:"Date",cellCls:"headerCol"},{html:"Hours",cellCls:"headerCol lastCol"}];if(0===me.timeEntries.length)return me._generateDetailContent(rows),rows;var selectedWorkpackageID=me.workpackageComboBox.getRecord().get("ObjectID"),selectedUserStoryID=me.userStoryComboBox.getRecord().get("ObjectID"),currentWorkpackageID,currentWorkpackageName,currentTeamName,currentUserName,currentWorkpackageRows,currentTeamRows,currentUserRows,currentItemRows,packageSumHours,userSumHours,proposalSumHours,workpackageCount,teamCount,userCount,workPackageName,teamName,who,index,item;for(index=0,proposalSumHours=0;;){if(!currentWorkpackageName||index!=me.filteredTimeEntries.length&&currentWorkpackageName==me.filteredTimeEntries[index].workpackageName||(me._setItemCount(workpackageCount,currentWorkpackageRows),me._setItemCount(teamCount,currentTeamRows,currentWorkpackageRows),me._setItemCount(userCount,currentUserRows,currentTeamRows,currentWorkpackageRows),rows=rows.concat(currentWorkpackageRows,currentTeamRows,currentUserRows,currentItemRows),rows=rows.concat(me._getSummaryRow(currentUserName,2,userSumHours),me._getSummaryRow(currentWorkpackageName,4,packageSumHours))),index==me.filteredTimeEntries.length)break;item=me.filteredTimeEntries[index],currentWorkpackageName!=item.workpackageName?(currentWorkpackageRows=[],me._setItemRowByWorkpackage(currentWorkpackageRows,item,!0,!0,!0),currentTeamRows=[],currentUserRows=[],currentItemRows=[],workpackageCount=2,teamCount=1,userCount=1,packageSumHours=0,userSumHours=0,currentWorkpackageName=item.workpackageName,currentTeamName=item.teamName,currentUserName=item.who):currentTeamName!=item.teamName?(me._setItemCount(teamCount,currentTeamRows,currentWorkpackageRows),me._setItemCount(userCount,currentUserRows,currentTeamRows,currentWorkpackageRows),currentWorkpackageRows=currentWorkpackageRows.concat(currentTeamRows,currentUserRows,currentItemRows,me._getSummaryRow(currentUserName,2,userSumHours)),currentTeamRows=[],me._setItemRowByWorkpackage(currentTeamRows,item,!1,!0,!0),currentUserRows=[],currentItemRows=[],teamCount=1,userCount=1,workpackageCount++,userSumHours=0,currentTeamName=item.teamName,currentUserName=item.who):currentUserName!=item.who?(me._setItemCount(userCount,currentUserRows,currentTeamRows,currentWorkpackageRows),currentTeamRows=currentTeamRows.concat(currentUserRows,currentItemRows,me._getSummaryRow(currentUserName,2,userSumHours)),currentUserRows=[],me._setItemRowByWorkpackage(currentUserRows,item,!1,!1,!0),currentItemRows=[],userCount=1,teamCount++,workpackageCount++,userSumHours=0,currentUserName=item.who):me._setItemRowByWorkpackage(currentItemRows,item,!1,!1,!1),workpackageCount++,teamCount++,userCount++,packageSumHours=me._roundFloatNumber(packageSumHours+item.hours),userSumHours=me._roundFloatNumber(userSumHours+item.hours),proposalSumHours=me._roundFloatNumber(proposalSumHours+item.hours),index++}return selectedWorkpackageID||selectedUserStoryID||(rows=rows.concat(me._getSummaryRow(this.proposalComboBox.getRawValue(),5,proposalSumHours))),me._generateDetailContent(rows),rows},_getTableByTeam:function(){var me=this,rows=[{html:"Team",cellCls:"headerCol"},{html:"Work Package",cellCls:"headerCol"},{html:"Who",cellCls:"headerCol"},{html:"Work Item",cellCls:"headerCol"},{html:"Date",cellCls:"headerCol"},{html:"Hours",cellCls:"headerCol lastCol"}];if(0===me.timeEntries.length)return me._generateDetailContent(rows),rows;var selectedWorkpackageID=me.workpackageComboBox.getRecord().get("ObjectID"),selectedUserStoryID=me.userStoryComboBox.getRecord().get("ObjectID"),currentWorkpackageID,currentWorkpackageName,currentTeamName,currentUserName,currentWorkpackageRows,currentTeamRows,currentUserRows,currentItemRows,teamSumHours,userSumHours,proposalSumHours,workpackageCount,teamCount,userCount,workPackageName,teamName,who,index,item;for(index=0,proposalSumHours=0;;){if(!currentTeamName||index!=me.filteredTimeEntries.length&&currentTeamName==me.filteredTimeEntries[index].teamName||(me._setItemCount(teamCount,currentTeamRows),me._setItemCount(workpackageCount,currentWorkpackageRows,currentTeamRows),me._setItemCount(userCount,currentUserRows,currentWorkpackageRows,currentTeamRows),rows=rows.concat(currentTeamRows,currentWorkpackageRows,currentUserRows,currentItemRows),rows=rows.concat(me._getSummaryRow(currentUserName,2,userSumHours),me._getSummaryRow(currentTeamName,4,teamSumHours))),index==me.filteredTimeEntries.length)break;item=me.filteredTimeEntries[index],currentTeamName!=item.teamName?(currentTeamRows=[],me._setItemRowByTeam(currentTeamRows,item,!0,!0,!0),currentWorkpackageRows=[],currentUserRows=[],currentItemRows=[],teamCount=2,workpackageCount=1,userCount=1,teamSumHours=0,userSumHours=0,currentTeamName=item.teamName,currentWorkpackageName=item.workpackageName,currentUserName=item.who):currentWorkpackageName!=item.workpackageName?(me._setItemCount(workpackageCount,currentWorkpackageRows,currentTeamRows),me._setItemCount(userCount,currentUserRows,currentWorkpackageRows,currentTeamRows),currentTeamRows=currentTeamRows.concat(currentWorkpackageRows,currentUserRows,currentItemRows,me._getSummaryRow(currentUserName,2,userSumHours)),currentWorkpackageRows=[],me._setItemRowByTeam(currentWorkpackageRows,item,!1,!0,!0),currentUserRows=[],currentItemRows=[],workpackageCount=1,userCount=1,teamCount++,userSumHours=0,currentWorkpackageName=item.workpackageName,currentUserName=item.who):currentUserName!=item.who?(me._setItemCount(userCount,currentUserRows,currentWorkpackageRows,currentTeamRows),currentWorkpackageRows=currentWorkpackageRows.concat(currentUserRows,currentItemRows,me._getSummaryRow(currentUserName,2,userSumHours)),currentUserRows=[],me._setItemRowByTeam(currentUserRows,item,!1,!1,!0),currentItemRows=[],userCount=1,workpackageCount++,teamCount++,userSumHours=0,currentUserName=item.who):me._setItemRowByTeam(currentItemRows,item,!1,!1,!1),teamCount++,workpackageCount++,userCount++,teamSumHours=me._roundFloatNumber(teamSumHours+item.hours),userSumHours=me._roundFloatNumber(userSumHours+item.hours),proposalSumHours=me._roundFloatNumber(proposalSumHours+item.hours),index++}return selectedWorkpackageID||selectedUserStoryID||(rows=rows.concat(me._getSummaryRow(this.proposalComboBox.getRawValue(),5,proposalSumHours))),me._generateDetailContent(rows),rows},_getSummaryRow:function(groupName,colspan,groupSumHours){return[{html:groupName+" Total",colspan:colspan,cellCls:"totalCol"},{html:groupSumHours,cellCls:"lastCol"}]},_setItemCount:function(count,rows1,rows2,rows3){rows3?rows1.length>0?rows1[0].rowspan=count:rows2.length>0&&"groupCol"==rows2[1].cellCls?rows2[1].rowspan=count:rows3[2].rowspan=count:rows2?rows1.length>0&&"groupCol"==rows1[1].cellCls?rows1[0].rowspan=count:rows2[1].rowspan=count:rows1[0].rowspan=count},_setItemRowByWorkpackage:function(rows,item,includeWorkpackage,includeTeam,includeUser){includeWorkpackage&&rows.push({html:item.workpackageName,rowspan:1,cellCls:"groupCol"}),includeTeam&&rows.push({html:item.teamName,rowspan:1,cellCls:"groupCol"}),includeUser&&rows.push({html:item.who,rowspan:1,cellCls:"groupCol"}),rows.push({html:item.workItem},{html:Ext.Date.format(item.date,"d/m/Y")},{html:item.hours,cellCls:"lastCol"})},_setItemRowByTeam:function(rows,item,includeTeam,includeWorkpackage,includeUser){includeTeam&&rows.push({html:item.teamName,rowspan:1,cellCls:"groupCol"}),includeWorkpackage&&rows.push({html:item.workpackageName,rowspan:1,cellCls:"groupCol"}),includeUser&&rows.push({html:item.who,rowspan:1,cellCls:"groupCol"}),rows.push({html:item.workItem},{html:Ext.Date.format(item.date,"d/m/Y")},{html:item.hours,cellCls:"lastCol"})},_sortTimeEntriesByWorkPackage:function(){var me=this;Ext.Array.sort(this.timeEntries,function(a,b){return a.workpackageName<b.workpackageName?-1:a.workpackageName>b.workpackageName?1:a.teamName<b.teamName?-1:a.teamName>b.teamName?1:a.who<b.who?-1:a.who>b.who?1:a.workItem<b.workItem?-1:a.workItem>b.workItem?1:a.date<b.date?-1:a.date>b.date?1:0})},_sortTimeEntriesByTeam:function(){Ext.Array.sort(this.timeEntries,function(a,b){return a.teamName<b.teamName?-1:a.teamName>b.teamName?1:a.workpackageName<b.workpackageName?-1:a.workpackageName>b.workpackageName?1:a.who<b.who?-1:a.who>b.who?1:a.workItem<b.workItem?-1:a.workItem>b.workItem?1:a.date<b.date?-1:a.date>b.date?1:0})},_getRootParentID:function(objectID){var parentID=this.treeMap.get(objectID);return parentID?this._getRootParentID(parentID):objectID},_showDialog:function(action){var me=this;me.dialog=Ext.create("Rally.ui.dialog.Dialog",{autoShow:!1,draggable:!0,closable:!0,autoDestroy:!0,closeAction:"hide",title:action.title,listeners:{scope:me},items:[{xtype:"component",html:"What would you like to "+action.title.toLowerCase()+"?",padding:"20 0 20 20",style:"label{align:left;font-size:15px; font-weight:bold;}"},{xtype:"container",width:500,padding:"20 10 20 10",margin:"0 20 40 20",border:1,style:{borderColor:"lightgrey",borderStyle:"solid"},items:[{xtype:"radiogroup",itemId:"summaryType",columns:1,items:[{xtype:"radiofield",boxLabel:"Summary list of items",boxLabelCls:"radioButtonLabel",name:"summaryType",checked:!0,inputValue:me.SUMMARY_WITHOUT_CHILDREN},{xtype:"radiofield",boxLabel:"Summary list of items with children",boxLabelCls:"radioButtonLabel",name:"summaryType",inputValue:me.SUMMARY_WITH_CHILDREN}],listeners:{scope:me}}]},{xtype:"container",width:500,margin:"0 20 20 20",layout:{type:"hbox",align:"middle",pack:"center"},listeners:{scope:me},items:[{xtype:"button",text:action.title.charAt(0)+action.title.slice(1).toLowerCase(),scope:me,handler:function(){me.currentSummaryType=Ext.ComponentQuery.query("#summaryType")[0].getChecked()[0].inputValue,me.dialog.close(),Ext.ComponentQuery.query("#summaryType")[0].destroy(),action.func.call(me,!0)}},{xtype:"button",margin:"0 0 0 10",text:"Cancel",handler:function(){me.dialog.close(),Ext.ComponentQuery.query("#summaryType")[0].destroy()}}]}]}),me.dialog.show(),me.dialog.center()},_exportReport:function(isSummaryReport){var me=this;isSummaryReport&&me._generateSummaryContent();var ua=window.navigator.userAgent;if(ua.indexOf("MSIE ")>0||navigator.userAgent.match(/Trident.*rv\:11\./)){var content=me.EXCEL_TEMPLATE+me.excelContent+"</body></html>",blob=new Blob([content]);window.navigator.msSaveOrOpenBlob(blob,me.EXCEL_FILE_NAME)}else me.downloadLink=document.createElement("a"),me.downloadLink.setAttribute("href",me.EXCEL_URI+me._base64(me.EXCEL_TEMPLATE+me.excelContent+"</body></html>")),me.downloadLink.setAttribute("download",me.EXCEL_FILE_NAME),me.downloadLink.setAttribute("target","_blank"),document.body.appendChild(me.downloadLink),me.downloadLink.click()},_printReport:function(isSummaryReport){var me=this;isSummaryReport&&me._generateSummaryContent();var myWindow=me._openWindow(1024,768);myWindow.document.title="Timesheet",myWindow.document.write('<html><head><style type="text/css">table{border-collapse: collapse;}table,th,td{border:1px solid black;}</style></head><body>'),myWindow.document.write(me.excelContent),myWindow.document.write("</body></html>"),myWindow.location.reload(),myWindow.focus(),myWindow.print(),myWindow.close()
},_generateSummaryContent:function(){var me=this;me.excelContent=me._getExcelParamterContent(),me.excelContent+="<table border=1 style='font-size:11pt'>",me.excelContent+="<tr><th>ID</th><th>NAME</th><th>PROJECT</th><th>OWNER</th><th>STATE</th><th>US/DE PLAN ESTIMATE</th><th>TASK ESTIMATE</th><th>TASK TO DO</th><th>TIME SPENT</th><th>TIME SPENT TOTAL</th><th>OUTSTANDING&nbsp;(PLAN EST LESS SPENT)</th></tr>",me.summaryRowMap.each(function(rows){me.currentSummaryType==me.SUMMARY_WITHOUT_CHILDREN?me.excelContent+=rows[0]:_.each(rows,function(row){me.excelContent+=row})}),me.excelContent+="</table>"},_generateSummaryRowMap:function(){var me=this;me.summaryRowMap=new Ext.util.MixedCollection;var userStory,rows;if(me.userStoryComboBox.getRecord().get("_ref"))userStory=me.userStoryComboBox.getRecord(),rows=[],me._generateArtifactContent(userStory,0,rows),me.summaryRowMap.add(userStory.get("ObjectID"),rows);else for(var i=1,len=me.epicUserStoryStore.getRecords().length;len>i;i++)rows=[],userStory=me.epicUserStoryStore.getRecords()[i],me._generateArtifactContent(userStory,0,rows),me.summaryRowMap.add(userStory.get("ObjectID"),rows)},_generateArtifactContent:function(artifact,indent,rows){var me=this,timeSpentTotal,objectID=artifact.get("ObjectID"),usContent="<tr>";usContent+="<td style='vertical-align:top'>"+me._getSpace(indent)+artifact.get("FormattedID")+"</td>",usContent+="<td style='vertical-align:top'>"+artifact.get("Name")+"</td>",usContent+="<td style='vertical-align:top;white-space: nowrap'>"+artifact.get("Project").Name+"</td>",usContent+="<td style='vertical-align:top'>"+(artifact.get("Owner")?artifact.get("Owner")._refObjectName:"")+"</td>",usContent+="<td style='vertical-align:top'>"+artifact.get("ScheduleState")+"</td>",usContent+="<td style='vertical-align:top' width=70>"+me._processNumberValue(artifact.get("PlanEstimate"),!0)+"</td>",usContent+="<td style='vertical-align:top' width=70>"+me._processNumberValue(artifact.get("TaskEstimateTotal"),!0)+"</td>",usContent+="<td style='vertical-align:top' width=60>"+me._processNumberValue(artifact.get("TaskRemainingTotal"),!0)+"</td>",usContent+="<td style='vertical-align:top' width=60>"+me._processNumberValue(me.artifactTimeSpentMap.get(objectID),!0)+"</td>",timeSpentTotal="hierarchicalrequirement"!=artifact.get("_type")||artifact.get("Parent")?"":me._processNumberValue(me.timeSpentMap.get(objectID),!0),usContent+="<td style='vertical-align:top' width=60>"+timeSpentTotal+"</td>",usContent+="hierarchicalrequirement"==artifact.get("_type")&&!artifact.get("Parent")&&artifact.get("PlanEstimate")&&me.timeSpentMap.get(objectID)?"<td style='vertical-align:top' width=100>"+me._roundFloatNumber(me._processNumberValue(artifact.get("PlanEstimate"),!1)-me._processNumberValue(me.timeSpentMap.get(objectID),!1))+"</td>":"<td style='vertical-align:top' width=100></td>",usContent+="</tr>",rows.push(usContent),_.each(me.schedulableArtifacts,function(schedulableArtifact){(schedulableArtifact.get("Parent")&&schedulableArtifact.get("Parent").ObjectID==objectID||schedulableArtifact.get("Requirement")&&schedulableArtifact.get("Requirement").ObjectID==objectID)&&me._generateArtifactContent(schedulableArtifact,indent+me.INDENT,rows)}),_.each(me.tasks,function(task){task.get("WorkProduct").ObjectID==objectID&&me._getTaskContent(task,indent+me.INDENT,rows)})},_getTaskContent:function(task,indent,rows){var me=this,objectID=task.get("ObjectID"),taskContent="<tr>";taskContent+="<td>"+me._getSpace(indent)+task.get("FormattedID")+"</td>",taskContent+="<td>"+task.get("Name")+"</td>",taskContent+="<td style='white-space: nowrap'>"+task.get("Project").Name+"</td>",taskContent+="<td>"+(task.get("Owner")?task.get("Owner")._refObjectName:"")+"</td>",taskContent+="<td>"+task.get("State")+"</td>",taskContent+="<td></td>",taskContent+="<td>"+me._processNumberValue(task.get("Estimate"),!0)+"</td>",taskContent+="<td>"+me._processNumberValue(task.get("ToDo"),!0)+"</td>",taskContent+="<td>"+me._processNumberValue(me.timeSpentMap.get(objectID),!0)+"</td>",taskContent+="<td></td>",taskContent+="<td></td>",taskContent+="</tr>",rows.push(taskContent)},_getSpace:function(number){for(var spaceStr="",i=0;number>i;i++)spaceStr+="&nbsp;";return spaceStr},_generateDetailContent:function(rows){var me=this;if(me.excelContent=me._getExcelParamterContent(),0!==rows.length){me.excelContent+="<table border=1 style='border-collapse: collapse;font-size:11pt'>",me.excelContent+="<tr>";for(var index=0,item;;){if(index==rows.length){me.excelContent+="</tr>";break}item=rows[index],item.cellCls&&item.cellCls.indexOf("headerCol")>=0?(me.excelContent+="<th>",me.excelContent+=item.html,me.excelContent+="</th>"):item.rowspan?(me.excelContent+="<td style='text-align: center;vertical-align: top;' rowspan="+item.rowspan+">",me.excelContent+=item.html,me.excelContent+="</td>"):item.colspan?(me.excelContent+="<td style='text-align: center;font-weight: bold;vertical-align: top' bgcolor=lightgrey colspan="+item.colspan+">",me.excelContent+=item.html,me.excelContent+="</td>"):(me.excelContent+="<td style='vertical-align: top;'>",me.excelContent+=item.html,me.excelContent+="</td>"),item.cellCls&&item.cellCls.indexOf("lastCol")>=0&&(me.excelContent+="</tr>",index!=rows.length-1&&(me.excelContent+="<tr>")),index++}me.excelContent+="</table>"}},_getExcelParamterContent:function(){var me=this,parameterContent="";return parameterContent+=me.proposalComboBox.getRawValue()+", ",parameterContent+=me.workpackageComboBox.getRecord().get("_ref")?me.workpackageComboBox.getRawValue()+", ":"All work packages, ",parameterContent+=me.userStoryComboBox.getRecord().get("_ref")?me.userStoryComboBox.getRawValue():"All user stories",parameterContent+="<br>"+Ext.Date.format(me.startDatePicker.getValue(),"d/m/Y")+" - "+Ext.Date.format(me.endDatePicker.getValue(),"d/m/Y")+"<br>"},_processNumberValue:function(value,forDisplay){return value?value:forDisplay?"":0},_roundFloatNumber:function(number){return Math.round(100*number)/100},_toISOString:function(date){return Ext.Date.format(date,"Y-m-d")+"T00:00:00.000Z"},_base64:function(s){return window.btoa(unescape(encodeURIComponent(s)))},_openWindow:function(width,height){var left=screen.width/2-width/2,top=screen.height/2-height/2;return window.open("about:blank","","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, copyhistory=no, width="+width+", height="+height+", top="+top+", left="+left)},_getEpicUserStoryFilter:function(){return this.workpackageComboBox.getRecord().get("_ref")?[{property:"WorkPackage",operation:"=",value:this.workpackageComboBox.getRecord().get("_ref")},{property:"Parent",operation:"=",value:null}]:[{property:"WorkPackage.Parent",operation:"=",value:this.proposalComboBox.getRecord().get("_ref")},{property:"Parent",operation:"=",value:null}]},_getUserStoryFilter:function(){return this.workpackageComboBox.getRecord().get("_ref")?[{property:"WorkPackage",operation:"=",value:this.workpackageComboBox.getRecord().get("_ref")}]:[{property:"WorkPackage.Parent",operation:"=",value:this.proposalComboBox.getRecord().get("_ref")}]},_getTreeUserStoryFilter:function(){return this.userStoryComboBox.getValue()?[{property:"ObjectID",operation:"=",value:this.userStoryComboBox.getRecord().get("ObjectID")}]:this.workpackageComboBox.getRecord().get("_ref")?[{property:"WorkPackage",operation:"=",value:this.workpackageComboBox.getRecord().get("_ref")},{property:"Parent",operation:"=",value:null}]:[{property:"WorkPackage.Parent",operation:"=",value:this.proposalComboBox.getRecord().get("_ref")},{property:"Parent",operation:"=",value:null}]}});

            Rally.launchApp('CustomApp', {
                name:"TimeSheetReport",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
